<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cimbar Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hide scrollbars for an app-like feel */
        body {
            overscroll-behavior: none;
            touch-action: none;
        }

        /* The scanner scanning line animation */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            box-shadow: 0 0 10px #00ff00;
            animation: scan 2.5s linear infinite;
        }

        @keyframes scan {
            0% {
                top: 10%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 90%;
                opacity: 0;
            }
        }

        /* CRT-like grid overlay */
        .grid-overlay {
            background-image:
                linear-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
    </style>
</head>

<body class="bg-black text-green-400 font-mono h-screen w-screen overflow-hidden flex flex-col">

    <!-- Top Bar -->
    <div
        class="absolute top-0 w-full z-20 p-4 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent">
        <div class="text-xl font-bold tracking-widest text-green-500 drop-shadow-[0_0_5px_rgba(0,255,0,0.8)]">
            CIMBAR<span class="text-white text-xs align-top ml-1">WEB</span></div>
        <div id="status-badge"
            class="px-2 py-1 rounded border border-red-500 text-red-500 text-xs uppercase font-bold bg-black/50">Offline
        </div>
    </div>

    <!-- Main Viewport (Camera + Overlay) -->
    <div class="relative flex-1 bg-gray-900 w-full flex justify-center items-center overflow-hidden">

        <!-- Camera Video Feed -->
        <video id="camera-feed" class="absolute min-w-full min-h-full object-cover" autoplay playsinline muted></video>

        <!-- Hidden Canvas for Processing Frames -->
        <canvas id="process-canvas" class="hidden"></canvas>

        <!-- Scanning Overlay UI -->
        <div class="absolute inset-0 z-10 pointer-events-none">
            <!-- Darkened borders -->
            <div class="absolute inset-0 border-[40px] border-black/50"></div>

            <!-- Central Reticle -->
            <div
                class="absolute inset-0 m-auto w-64 h-64 border-2 border-green-500/50 rounded-lg flex items-center justify-center grid-overlay shadow-[0_0_20px_rgba(0,255,0,0.2)]">
                <!-- Corner Markers -->
                <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-green-500 -mt-1 -ml-1"></div>
                <div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-green-500 -mt-1 -mr-1"></div>
                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-green-500 -mb-1 -ml-1"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-green-500 -mb-1 -mr-1"></div>

                <!-- Scanning Animation -->
                <div class="scan-line"></div>
            </div>

            <!-- Debug Text Overlay -->
            <div class="absolute bottom-24 left-0 w-full text-center">
                <p id="debug-info" class="text-xs text-green-300/70 bg-black/40 inline-block px-2 py-1 rounded">
                    Initializing Camera...</p>
            </div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div
        class="relative z-20 bg-black/90 p-6 pb-10 flex flex-col items-center justify-center space-y-4 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,255,0,0.1)]">

        <!-- Result Display Area -->
        <div id="result-area" class="w-full hidden">
            <div class="bg-gray-800 border border-green-600 rounded p-3 mb-4">
                <div class="text-xs text-gray-400 mb-1">DECODED CONTENT</div>
                <div id="result-text" class="text-white break-all font-mono text-sm h-20 overflow-y-auto"></div>
                <div class="mt-2 flex justify-end space-x-2">
                    <button onclick="copyResult()"
                        class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white">Copy</button>
                    <button onclick="resetScanner()"
                        class="text-xs bg-green-700 hover:bg-green-600 px-3 py-1 rounded text-white">Scan Again</button>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div id="controls-area" class="flex space-x-6">
            <!-- Camera Toggle -->
            <button onclick="toggleCamera()"
                class="flex flex-col items-center justify-center space-y-1 text-gray-400 hover:text-white transition">
                <div class="w-12 h-12 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <span class="text-xs">Cam</span>
            </button>

            <!-- SIMULATE Button (Because no JS decoder exists) -->
            <button onclick="simulateDecode()"
                class="flex flex-col items-center justify-center space-y-1 text-green-400 hover:text-green-300 transition animate-pulse">
                <div
                    class="w-16 h-16 rounded-full bg-green-900/30 border-2 border-green-500 flex items-center justify-center shadow-[0_0_15px_rgba(0,255,0,0.4)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <span class="text-xs font-bold">SIMULATE</span>
            </button>

            <!-- Info Button -->
            <button onclick="toggleInfo()"
                class="flex flex-col items-center justify-center space-y-1 text-gray-400 hover:text-white transition">
                <div class="w-12 h-12 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-xs">Info</span>
            </button>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-50 bg-black/95 hidden flex flex-col justify-center items-center p-6">
        <div class="bg-gray-900 border border-green-800 p-6 rounded-lg max-w-sm w-full">
            <h2 class="text-lg font-bold text-green-400 mb-2">About Cimbar Web</h2>
            <p class="text-sm text-gray-300 mb-4">
                This is a <strong class="text-white">Scanner Scaffold</strong>.
                <br><br>
                Cimbar requires complex C++ logic (libcimbar) to decode. A pure JavaScript decoder does not yet exist.
            </p>
            <p class="text-sm text-gray-400 mb-6 italic">
                To make this real: Compile libcimbar to WASM and hook it into the <code>scanFrame()</code> function in
                the source.
            </p>
            <button onclick="toggleInfo()" class="w-full bg-green-700 py-2 rounded text-white font-bold">Close</button>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('process-canvas');
        const ctx = canvas.getContext('2d');
        const debugInfo = document.getElementById('debug-info');
        const statusBadge = document.getElementById('status-badge');

        let isScanning = false;
        let scanInterval = null;

        // --- Camera Setup ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment", // Use back camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    isScanning = true;
                    statusBadge.innerText = "Active";
                    statusBadge.className = "px-2 py-1 rounded border border-green-500 text-green-500 text-xs uppercase font-bold bg-black/50";
                    startScanningLoop();
                };
            } catch (err) {
                console.error("Camera Error:", err);
                debugInfo.innerText = "Error: Camera access denied or unavailable.";
                statusBadge.innerText = "Error";
            }
        }

        function toggleCamera() {
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
                isScanning = false;
                clearInterval(scanInterval);
                debugInfo.innerText = "Camera Paused";
                statusBadge.innerText = "Paused";
                statusBadge.className = "px-2 py-1 rounded border border-gray-500 text-gray-500 text-xs uppercase font-bold bg-black/50";
            } else {
                startCamera();
            }
        }

        // --- Scanning Logic (The Placeholder) ---
        function startScanningLoop() {
            // Check for codes every 100ms
            scanInterval = setInterval(scanFrame, 100);
        }

        function scanFrame() {
            if (!isScanning || !video.videoWidth) return;

            // 1. Draw video frame to canvas for processing
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 2. Extract Image Data (Pixel Array)
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // --- REAL IMPLEMENTATION GAP ---
            // Here is where you would call the WASM function.
            // Example: 
            // const result = libcimbar.decode_frame(imageData.data, canvas.width, canvas.height);

            // Since we don't have the WASM module loaded, we just update stats
            debugInfo.innerText = `Scanning: ${canvas.width}x${canvas.height}px | FPS: 30`;
        }

        // --- Simulation (User Experience) ---
        function simulateDecode() {
            // Mimic a "Processing" state
            debugInfo.innerText = "Pattern Detected... Decoding...";
            debugInfo.classList.add("text-white");

            setTimeout(() => {
                // Mimic success
                const fakeData = "Cimbar Project: High density air-gapped transfer successful.\nPacket ID: #8842\nPayload: 14kb";
                showResult(fakeData);
            }, 1500);
        }

        // --- UI Handling ---
        function showResult(text) {
            isScanning = false;
            clearInterval(scanInterval); // Stop processing to save battery

            document.getElementById('controls-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('result-text').innerText = text;

            // Haptic feedback if available
            if (navigator.vibrate) navigator.vibrate(200);
        }

        function resetScanner() {
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('controls-area').classList.remove('hidden');
            isScanning = true;
            startScanningLoop();
            debugInfo.innerText = "Resumed Scanning...";
        }

        function copyResult() {
            const text = document.getElementById('result-text').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("Copied to clipboard!");
            });
        }

        function toggleInfo() {
            const modal = document.getElementById('info-modal');
            modal.classList.toggle('hidden');
        }

        // Auto-start
        window.onload = startCamera;

    </script>
</body>

</html>